{% extends 'voting/base.html' %}
{% load i18n %}
{% block title %}{% trans "Cast Your Vote" %}{% endblock %}

{% block content %}
<div class="content-card dashboard-card">
    <form id="voteForm" method="post" action="{% url 'voting:election_view' %}">
        {% csrf_token %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">{% trans "Your Ballot" %}</h1>
            <div>
                <a href="{% url 'voting:voter_home' %}" class="btn btn-secondary-biomatdaan">{% trans "Cancel" %}</a>
                <button type="submit" class="btn btn-primary-biomatdaan ms-2">{% trans "Submit Vote" %}</button>
            </div>
        </div>
        
        <div id="form-error" class="alert alert-danger d-none"></div>

        {% for post in posts %}
            <div class="mb-5">
                <h4 class="post-title">{{ post.title }}</h4>
                <div class="candidate-list" data-post-id="{{ post.id }}">
                    {% for candidate in post.candidates.all %}
                        <label class="candidate-card" for="candidate-{{ candidate.id }}">
                            <input class="form-check-input d-none" type="radio" name="post_{{ post.id }}" id="candidate-{{ candidate.id }}" value="{{ candidate.id }}">
                            {% if candidate.photo %}
                                <img src="{{ candidate.photo.url }}" alt="{{ candidate.name }}" class="photo">
                            {% else %}
                                <i class="fas fa-user-circle fa-3x text-secondary me-3"></i>
                            {% endif %}
                            <div class="candidate-info">
                                {{ candidate.name }}
                            </div>
                            {% if candidate.symbol %}
                                <img src="{{ candidate.symbol.url }}" alt="Symbol" class="symbol">
                            {% endif %}
                        </label>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Visually update selected candidate card
    const allRadios = document.querySelectorAll('.form-check-input');
    allRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Find all cards in the same post group
            const groupName = this.name;
            const postCards = document.querySelectorAll(`input[name="${groupName}"]`);
            postCards.forEach(r => {
                r.closest('.candidate-card').classList.remove('selected');
            });
            // Add selected class to the parent of the checked radio
            this.closest('.candidate-card').classList.add('selected');
        });
    });

    // Handle form submission and check for skipped posts
    const voteForm = document.getElementById('voteForm');
    voteForm.addEventListener('submit', function(event) {
        const posts = {{ posts|length }};
        const selectedPosts = new Set();
        const formData = new FormData(voteForm);
        
        for (let pair of formData.entries()) {
            if (pair[0].startsWith('post_')) {
                selectedPosts.add(pair[0]);
            }
        }

        if (selectedPosts.size < posts) {
            const confirmation = confirm("{% trans 'You have not voted for all positions. Are you sure you want to submit your vote?' %}");
            if (!confirmation) {
                event.preventDefault(); // Stop form submission
            }
        }
    });
});
</script>
{% endblock %}
